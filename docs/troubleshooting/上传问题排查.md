# 文档上传问题排查指南

## 已修复的问题

### 1. CORS配置 ✅
- **问题**: CORS只允许了 `localhost:3000`，但前端可能运行在其他端口
- **修复**: 添加了常用端口 `5173-5176` 到CORS允许列表
- **文件**: `backend/app/core/config.py`

### 2. Content-Type处理 ✅
- **问题**: API客户端默认设置了 `Content-Type: application/json`，会干扰文件上传
- **修复**: 移除了默认Content-Type，让axios根据数据类型自动设置
- **文件**: `frontend/src/api/client.ts`, `frontend/src/api/documents.ts`

## 排查步骤

### 1. 检查浏览器控制台

打开浏览器开发者工具 (F12)，查看 Console 标签页：

**常见错误**:
- `CORS policy`: CORS配置问题
- `Network Error`: 网络连接问题
- `404 Not Found`: API路径错误
- `500 Internal Server Error`: 后端错误

### 2. 检查网络请求

在 Network 标签页中：

1. **找到上传请求**
   - 请求方法: `POST`
   - 请求URL: `/api/v1/documents/upload`

2. **检查请求头**
   - `Content-Type`: 应该是 `multipart/form-data; boundary=...`
   - `Origin`: 应该是前端地址（如 `http://localhost:5173` 或 `http://localhost`）

3. **检查响应**
   - 状态码: 应该是 `201 Created`
   - 响应体: 应该包含 `document_id` 和 `task_id`

### 3. 检查后端服务

```bash
# 检查服务状态
docker-compose ps

# 查看后端日志
docker-compose logs backend --tail=50

# 测试API
curl -X POST http://localhost:8000/api/v1/documents/upload \
  -F "file=@test_document.md"
```

### 4. 检查前端配置

**Vite代理配置** (`frontend/vite.config.ts`):
```typescript
proxy: {
  '/api': {
    target: 'http://localhost:8000',
    changeOrigin: true,
  }
}
```

**API客户端配置** (`frontend/src/api/client.ts`):
```typescript
baseURL: '/api/v1'  // 会被代理到 http://localhost:8000/api/v1
```

## 常见问题及解决方案

### 问题1: CORS错误

**错误信息**: `Access to XMLHttpRequest at '...' from origin '...' has been blocked by CORS policy`

**解决方案**:
1. 检查后端CORS配置是否包含前端地址
2. 确认前端运行端口在CORS允许列表中
3. 重启后端服务

### 问题2: 文件上传失败但没有错误提示

**可能原因**:
1. 文件类型不在允许列表中
2. 文件大小超过30MB限制
3. 网络请求被拦截

**解决方案**:
1. 检查文件类型和大小
2. 查看浏览器控制台的错误信息
3. 检查网络请求的响应

### 问题3: 上传成功但页面没有跳转

**可能原因**:
1. 路由配置问题
2. 响应数据格式问题
3. 状态管理问题

**解决方案**:
1. 检查浏览器控制台是否有JavaScript错误
2. 确认响应包含 `document_id` 和 `task_id`
3. 检查路由配置是否正确

## 测试命令

### 测试后端API

```bash
# 上传文档
curl -X POST http://localhost:8000/api/v1/documents/upload \
  -F "file=@test_document.md" | python3 -m json.tool

# 查看健康状态
curl http://localhost:8000/health

# 查看API文档
open http://localhost:8000/docs
```

### 测试前端

1. 打开浏览器访问前端地址
2. 打开开发者工具 (F12)
3. 尝试上传文件
4. 查看控制台和网络请求

## 调试技巧

### 1. 添加日志

在 `frontend/src/pages/Upload.tsx` 的 `handleUpload` 函数中添加：

```typescript
console.log('开始上传:', selectedFile)
console.log('文件信息:', {
  name: selectedFile.name,
  size: selectedFile.size,
  type: selectedFile.type
})
```

### 2. 检查响应

在 `frontend/src/api/documents.ts` 中添加：

```typescript
upload: async (file: File) => {
  const formData = new FormData()
  formData.append('file', file)
  
  try {
    const response = await apiClient.post('/documents/upload', formData)
    console.log('上传成功:', response.data)
    return response.data
  } catch (error) {
    console.error('上传失败:', error)
    throw error
  }
}
```

## 如果问题仍然存在

1. **收集信息**:
   - 浏览器控制台的完整错误信息
   - 网络请求的详细信息（请求头、响应头、响应体）
   - 后端日志的相关部分

2. **检查环境**:
   - 前端服务是否正常运行
   - 后端服务是否正常运行
   - 端口是否被占用

3. **重新启动服务**:
   ```bash
   # 重启后端
   docker-compose restart backend
   
   # 重启前端（在frontend目录）
   npm run dev
   ```

---

**最后更新**: 2024-12-09

