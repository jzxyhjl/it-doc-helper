# 需求文档 - 可信度估计与来源片段引用

## 介绍

为系统增加可信度估计和来源片段引用功能，提升AI处理结果的可信度和可追溯性。用户可以通过可信度评估判断结果质量，通过来源片段验证AI结论的准确性。

同时，在调用AI之前增加文本预处理步骤，包括格式统一、文本清洗和噪声过滤，以提高AI处理的质量和效率。

## 需求 0 - 文本预处理（AI调用前）

### 用户故事：
作为系统，我需要在调用AI处理之前对文档内容进行格式统一、文本清洗和噪声过滤，以提高AI处理的质量和效率。

### 验收标准：

#### 0.1 文档格式统一
1. When 提取文档内容后，系统应当统一换行符（统一为\n）
2. When 提取文档内容后，系统应当统一空格（多个连续空格合并为单个空格，保留必要的缩进）
3. When 提取文档内容后，系统应当统一制表符（转换为空格或保留，根据上下文判断）
4. When 提取文档内容后，系统应当统一编码（确保所有文本为UTF-8编码）

#### 0.2 文本清洗
5. When 处理文档内容时，系统应当去除不可见字符（零宽字符、控制字符等）
6. When 处理文档内容时，系统应当修复常见的编码错误（如乱码字符）
7. When 处理文档内容时，系统应当去除多余的空白行（保留段落间的单个空行）
8. When 处理文档内容时，系统应当规范化标点符号（统一中英文标点，根据上下文判断）

#### 0.3 噪声过滤
9. When 处理PDF文档时，系统应当识别并去除页眉页脚（如页码、文档标题等重复内容）
10. When 处理PDF文档时，系统应当识别并去除水印和背景文字
11. When 处理文档内容时，系统应当去除重复的段落或句子（基于相似度检测）
12. When 处理文档内容时，系统应当去除无意义的短行（如单独的数字、符号等）
13. When 处理文档内容时，系统应当保留重要的结构化信息（如标题、列表、表格等）

#### 0.4 处理流程集成
14. When 文档内容提取完成后，系统应当立即进行文本预处理
15. When 文本预处理完成后，系统应当将清洗后的内容传递给类型识别和AI处理
16. When 文本预处理失败时，系统应当使用原始内容继续处理，并记录警告日志
17. When 文本预处理耗时过长（>10秒）时，系统应当使用快速模式，记录警告日志

#### 0.5 质量保证
18. When 文本预处理后，系统应当保留原始内容的语义完整性
19. When 文本预处理后，系统应当确保关键信息不丢失（如技术术语、代码片段等）
20. When 文本预处理后，系统应当记录预处理统计信息（如去除的字符数、清洗的段落数等）

## 需求 1 - 可信度估计

### 用户故事：
作为用户，我希望在处理结果中看到每个结论的可信度评估，以便判断结果的可靠性。

### 验收标准：
1. When AI处理文档时，系统应当为每个主要结论/要点计算可信度分数（0-100）
2. When 可信度分数 >= 75 时，系统应当标记为"高"
3. When 可信度分数在 40-74 之间时，系统应当标记为"中"
4. When 可信度分数 < 40 时，系统应当标记为"低"
5. When 处理技术文档时，系统应当在所有结果项中完整展示可信度（文本标签）
6. When 处理面试题文档时，系统应当弱展示可信度（可选显示）
7. When 处理架构文档时，系统应当弱展示可信度（可选显示）

## 需求 2 - 来源片段引用

### 用户故事：
作为用户，我希望看到AI结论对应的原文片段，以便验证结论的准确性。

### 验收标准：
1. When AI处理文档时，系统应当将文档内容按段落切分（以空行或Markdown block为分隔）
2. When 段落超长时，系统应当只截取命中最强的连续子段，而不是平均切块
3. When AI生成结论时，系统应当要求AI返回对应的来源片段编号（source_ids）
4. When 处理技术文档时，系统应当在所有结果项中完整展示来源片段
5. When 处理面试题文档时，系统应当弱展示来源片段（可选显示）
6. When 处理架构文档时，系统应当弱展示来源片段（可选显示）

## 需求 3 - 可信度加权计算

### 用户故事：
作为系统，我需要综合考虑多个因素来计算可信度，以便提供更准确的可信度评估。

### 验收标准：
1. When 计算可信度时，系统应当考虑检索命中强度（来源片段与结论的相关性）
2. When 计算可信度时，系统应当考虑top-k相似度（与相似文档的相似度）
3. When 计算可信度时，系统应当考虑来源集中度（是否集中在少数段落）
4. When AI回答超出文档内容时，系统应当降低可信度分数
5. When AI回答中出现文档不存在的概念时，系统应当降低可信度分数
6. When 检测到回答结构不稳定（自相矛盾）时，系统应当降低可信度分数
7. When 多次重算结果差异很大时，系统应当降低可信度分数

## 需求 4 - 前端展示

### 用户故事：
作为用户，我希望在前端界面中看到可信度和来源片段的展示，以便快速了解结果质量。

### 验收标准：
1. When 查看技术文档结果时，系统应当在每个结果项中显示可信度标签（高/中/低）
2. When 查看技术文档结果时，系统应当在每个结果项下方显示来源片段列表（可折叠/展开）
3. When 查看面试题/架构文档结果时，系统应当提供弱展示选项（默认隐藏，可点击展开）
4. When 来源片段展示时，系统应当显示片段编号和原文内容
5. When 来源片段展示时，系统应当支持折叠/展开功能（简单版实现）

## 需求 5 - 数据存储

### 用户故事：
作为系统，我需要将可信度和来源片段信息持久化存储，以便后续查询和展示。

### 验收标准：
1. When 保存处理结果时，系统应当将可信度分数和来源片段信息存储在result_data JSON中
2. When 存储来源片段时，系统应当保存片段编号、原文内容和位置信息
3. When 存储可信度时，系统应当保存数值分数和文本标签（高/中/低）

## 需求 6 - 异常处理与兜底逻辑

### 用户故事：
作为系统，我需要在各种异常情况下提供兜底方案，确保系统稳定运行和用户体验。

### 验收标准：

#### 6.1 段落切分异常处理
1. When 段落切分失败时，系统应当使用默认切分策略（按固定长度切分）作为兜底
2. When 文档内容为空时，系统应当返回空段落列表，不中断处理流程
3. When 超长段落处理失败时，系统应当返回整个段落，而不是报错

#### 6.2 AI返回格式异常处理
4. When AI返回的JSON格式不正确时，系统应当尝试提取有效字段，缺失字段使用默认值
5. When AI未返回source_ids时，系统应当使用空数组[]作为默认值
6. When AI未返回confidence时，系统应当使用默认可信度分数（50分，标签"中"）
7. When AI返回的source_ids超出段落范围时，系统应当过滤无效ID，只保留有效段落
8. When AI返回的confidence超出0-100范围时，系统应当自动修正到有效范围

#### 6.3 可信度计算异常处理
9. When 可信度计算过程中出现异常时，系统应当使用AI返回的基础可信度作为兜底
10. When 相似度计算失败时，系统应当使用默认相似度分数（0.5）
11. When 来源集中度计算失败时，系统应当使用默认集中度分数（0.5）
12. When 内容一致性检查失败时，系统应当跳过检查，不降分

#### 6.4 数据存储异常处理
13. When 可信度或来源信息存储失败时，系统应当记录错误日志，但不中断主流程
14. When result_data JSON序列化失败时，系统应当使用简化结构存储，确保核心数据不丢失

#### 6.5 前端展示异常处理
15. When 前端接收到不包含可信度信息的结果时，系统应当不显示可信度标签，正常展示其他内容
16. When 前端接收到不包含来源片段的结果时，系统应当不显示来源片段区域，正常展示其他内容
17. When 来源片段ID无效时，系统应当跳过该片段，不显示错误信息
18. When 可信度标签无法解析时，系统应当显示"未知"，而不是报错

#### 6.6 性能异常处理
19. When 段落切分耗时过长（>5秒）时，系统应当使用简化切分策略，记录警告日志
20. When 可信度计算耗时过长（>3秒）时，系统应当使用快速计算模式，记录警告日志
21. When 处理超时风险时，系统应当优先保证核心功能完成，可信度和来源信息可异步补充

#### 6.7 日志和监控
22. When 发生任何异常时，系统应当记录详细的错误日志，包含上下文信息
23. When 使用兜底逻辑时，系统应当记录警告日志，便于后续优化
24. When 异常频率过高时，系统应当触发告警机制（可选，未来扩展）

## 需求 7 - 明确的失败策略与用户反馈

### 用户故事：
作为用户，当系统处理失败时，我希望收到明确的错误信息和可操作的建议，而不是看到不准确或混乱的结果。

### 验收标准：

#### 7.1 AI调用失败处理
1. When AI API调用失败（网络错误、API错误等）时，系统应当将任务状态标记为"failed"，而不是返回空结果或默认值
2. When AI调用失败时，系统应当返回明确的错误信息，包含失败原因（如"AI服务暂时不可用"、"API密钥无效"等）
3. When AI调用失败时，系统应当提供用户可操作的建议（如"请检查网络连接"、"请验证API密钥配置"等）
4. When AI调用失败时，系统应当允许用户重试处理，而不是强制重新上传文档

#### 7.2 任务超时处理
5. When 文档处理任务超时（超过配置的最大处理时间）时，系统应当将任务状态标记为"timeout"，而不是返回部分结果
6. When 任务超时时，系统应当返回明确的超时信息，包含已完成的处理步骤和未完成的步骤
7. When 任务超时时，系统应当提供用户可操作的建议（如"文档过大，建议拆分后处理"、"可以稍后重试"等）
8. When 任务超时时，系统应当允许用户重新处理，保留已上传的文档

#### 7.3 不可理解文件处理
9. When 文档内容无法提取（文件损坏、格式不支持等）时，系统应当将任务状态标记为"failed"，而不是尝试处理空内容
10. When 文档内容为空或过短（<50字符）时，系统应当将任务状态标记为"failed"，并提示"文档内容过少，无法处理"
11. When 文档格式无法识别时，系统应当返回明确的错误信息，包含支持的文件格式列表
12. When 文档编码无法解析时，系统应当尝试多种编码，失败后返回明确的错误信息

#### 7.4 处理结果无效处理
13. When AI返回的结果格式完全无法解析时，系统应当将任务状态标记为"failed"，而不是返回空结果或默认值
14. When AI返回的结果明显不合理（如所有可信度为0、所有来源片段为空等）时，系统应当标记为"low_quality"，并提示用户结果质量可能存在问题
15. When 处理结果为空或关键字段缺失时，系统应当返回明确的错误信息，而不是返回空对象

#### 7.5 用户反馈机制
16. When 任务失败时，系统应当在前端显示明确的错误提示，包含错误类型、错误原因和操作建议
17. When 任务失败时，系统应当提供"重试"按钮，允许用户重新处理
18. When 任务失败时，系统应当提供"查看详情"链接，显示详细的错误日志（可选，用于调试）
19. When 任务部分成功时，系统应当明确标识哪些部分成功、哪些部分失败

#### 7.6 防止"胡乱返回"机制
20. When 任何处理步骤失败时，系统应当立即停止后续处理，而不是继续处理并返回不完整结果
21. When 关键数据缺失时，系统应当返回明确的失败状态，而不是使用猜测值填充
22. When 无法确定文档类型时，系统应当标记为"unknown"，而不是强制指定一个类型
23. When 处理结果质量过低（可信度<20且无有效来源）时，系统应当标记为"low_quality"，并提示用户结果可能不准确
24. When 系统检测到异常情况时，系统应当优先保证数据准确性，而不是为了显示结果而返回错误数据

#### 7.7 文档大小控制（结合超时方案）
25. When 文档文件大小超过30MB时，系统应当在上传阶段拒绝，返回明确的错误信息
26. When 文档内容提取后，系统应当根据内容长度估算处理时间
27. When 估算处理时间超过最大处理时间（300秒）时，系统应当在上传阶段拒绝，提示"文档过大，预计处理时间过长，建议拆分后处理"
28. When 文档内容长度超过阈值（如50万字符）时，系统应当在上传阶段拒绝，提示"文档内容过长，建议拆分后处理"
29. When 文档大小在警告阈值（如20MB）和拒绝阈值之间时，系统应当在上传时给出警告提示，但允许继续处理
30. When 文档处理过程中检测到可能超时时，系统应当提前终止，标记为"timeout"，而不是等待超时

