# 实施计划 - 可信度估计与来源片段引用

## 任务拆分

### 任务0: 创建文本预处理服务
- 创建 `backend/app/services/text_preprocessor.py`
- 实现格式统一功能（统一换行符、空格、制表符、编码）
- 实现文本清洗功能（去除不可见字符、修复编码错误、规范化标点符号）
- 实现噪声过滤功能（去除页眉页脚、水印、重复内容、无意义短行）
- 实现完整的预处理流程（格式统一 → 文本清洗 → 噪声过滤）
- 实现预处理统计信息收集
- 添加异常处理和超时保护（>10秒使用快速模式）
- 在文档处理任务中集成文本预处理（在内容提取后、类型识别前）
- 编写单元测试
- **需求**: REQ-0

### 任务1: 创建段落切分服务
- 创建 `backend/app/services/source_segmenter.py`
- 实现按空行和Markdown block切分逻辑
- 实现超长段落的最强连续子段提取算法
- 返回段落索引和映射关系
- 编写单元测试
- **需求**: REQ-2

### 任务2: 创建可信度计算服务
- 创建 `backend/app/services/confidence_calculator.py`
- 实现基础可信度处理
- 实现检索命中强度计算
- 实现top-k相似度计算
- 实现来源集中度计算
- 实现内容一致性检查（超出文档、不存在概念、自相矛盾、结果不稳定）
- 实现加权计算和最终分数生成
- 实现可信度标签转换（高/中/低）
- 编写单元测试
- **需求**: REQ-1, REQ-3

### 任务3: 增强AI服务
- 修改 `backend/app/services/ai_service.py`
- 添加支持传入段落索引的方法
- 增强prompt生成，要求返回source_ids和confidence
- 更新JSON解析逻辑，支持新字段
- **需求**: REQ-1, REQ-2

### 任务4: 增强技术文档处理器
- 修改 `backend/app/services/technical_processor.py`
- 集成段落切分服务
- 更新所有AI调用，传入段落索引
- 更新prompt，要求返回source_ids和confidence
- 集成可信度计算服务
- 更新结果结构，包含可信度和来源信息
- 更新所有子方法（前置条件、学习路径、学习方法、技术关联）
- **需求**: REQ-1, REQ-2, REQ-5

### 任务5: 增强面试题文档处理器
- 修改 `backend/app/services/interview_processor.py`
- 集成段落切分服务
- 更新AI调用，传入段落索引
- 更新prompt，要求返回source_ids和confidence
- 集成可信度计算服务
- 更新结果结构（弱展示模式）
- **需求**: REQ-1, REQ-2, REQ-5

### 任务6: 增强架构文档处理器
- 修改 `backend/app/services/architecture_processor.py`
- 集成段落切分服务
- 更新所有AI调用，传入段落索引
- 更新prompt，要求返回source_ids和confidence
- 集成可信度计算服务
- 更新结果结构（弱展示模式）
- **需求**: REQ-1, REQ-2, REQ-5

### 任务7: 更新前端技术文档结果展示
- 修改 `frontend/src/pages/Result.tsx`
- 更新 `TechnicalResult` 组件
- 添加可信度标签显示（高/中/低，带颜色）
- 添加来源片段展示（可折叠/展开）
- 处理向后兼容（旧数据不显示）
- **需求**: REQ-4

### 任务8: 更新前端面试题结果展示（弱展示）
- 修改 `frontend/src/pages/Result.tsx`
- 更新 `InterviewResult` 组件
- 添加可信度和来源片段的弱展示（默认隐藏，可点击展开）
- **需求**: REQ-4

### 任务9: 更新前端架构文档结果展示（弱展示）
- 修改 `frontend/src/pages/Result.tsx`
- 更新 `ArchitectureResult` 组件
- 添加可信度和来源片段的弱展示（默认隐藏，可点击展开）
- **需求**: REQ-4

### 任务10: 实现异常处理和兜底逻辑
- 在段落切分服务中添加异常处理和兜底逻辑
- 在可信度计算服务中添加异常处理和兜底逻辑
- 在AI服务中添加返回格式验证和修正逻辑
- 在处理器中添加异常捕获和降级处理
- 在前端组件中添加数据缺失和异常处理
- 添加超时保护机制
- 添加详细的错误日志
- **需求**: REQ-6

### 任务11: 实现文档大小控制
- 创建文档大小验证服务（DocumentSizeValidator）
- 实现处理时间估算算法
- 实现文件大小阈值检查（警告/拒绝）
- 实现内容长度阈值检查（警告/拒绝）
- 实现处理时间阈值检查（警告/拒绝）
- 在文档上传阶段集成大小验证
- 在文档提取后集成内容长度验证
- 实现提前终止机制（检测到可能超时时提前终止）
- 在前端添加文档大小警告提示
- 更新错误信息，包含文档大小相关建议
- **需求**: REQ-7

### 任务12: 实现失败策略和用户反馈
- 创建失败状态枚举和错误类型定义
- 创建错误信息结构类（ProcessingException）
- 在文档处理任务中实现失败检测和状态管理
- 实现AI调用失败处理（明确标记failed，提供错误信息）
- 实现任务超时处理（标记timeout，提供已完成的步骤信息）
- 实现不可理解文件处理（文件损坏、内容为空等）
- 实现处理结果验证（防止保存无效结果）
- 实现质量检查（low_quality状态）
- 创建用户操作建议映射
- 在前端实现错误展示组件
- 实现重试功能
- 实现错误详情展示
- **需求**: REQ-7

### 任务13: 集成测试和验证
- 测试完整处理流程
- 测试不同文档类型
- 测试边界情况（超长段落、无来源、低可信度等）
- 测试异常场景（AI返回格式错误、计算失败等）
- 测试失败场景（AI调用失败、超时、文件损坏等）
- 测试兜底逻辑（确保异常情况下系统仍能正常工作）
- 测试失败策略（确保不会"胡乱返回"）
- 验证前端展示效果（包括异常和失败情况下的展示）
- 性能测试
- **需求**: 所有需求

## 实施顺序

### 第一阶段：核心基础设施（任务0-3）
1. 文本预处理服务
2. 段落切分服务
3. 可信度计算服务
4. AI服务增强

### 第二阶段：后端处理器增强（任务4-6）
1. 技术文档处理器（完整展示）
2. 面试题文档处理器（弱展示）
3. 架构文档处理器（弱展示）

### 第三阶段：前端展示（任务7-9）
1. 技术文档结果展示
2. 面试题结果展示（弱展示）
3. 架构文档结果展示（弱展示）

### 第四阶段：失败策略和异常处理（任务10-12）
1. 实现异常处理和兜底逻辑
2. 实现文档大小控制
3. 实现失败策略和用户反馈
4. 集成测试（包括异常和失败场景）
5. 性能优化
6. 文档更新

## 注意事项

1. **向后兼容**：确保旧数据可以正常显示（不包含可信度和来源信息时）
2. **性能考虑**：段落切分和可信度计算可能增加处理时间，需要优化
3. **错误处理**：AI返回格式不正确时，需要有降级方案
4. **测试覆盖**：确保新功能有充分的测试覆盖

