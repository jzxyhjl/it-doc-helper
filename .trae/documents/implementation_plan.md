# 实施计划

## 项目概述

基于三个需求的实施计划，按照优先级和依赖关系进行分阶段实施。

---

## 第一阶段：快速实现（已完成 ✅）

### 需求1：首页历史记录展示

**状态：✅ 已完成**

**完成内容：**
- ✅ 首页顶部主叙事重新设计
- ✅ 单一主入口卡片设计
- ✅ 历史记录独立区块展示（最近5条）
- ✅ 右上角快速入口
- ✅ 弱化入口提示

**技术实现：**
- 前端：`frontend/src/pages/Home.tsx`
- API：复用 `historyApi.getHistory()`
- 显示逻辑：自动加载最近10条，展示前5条

---

## 第二阶段：核心功能（待实施）

### 需求3：隐藏空视角切换按钮

**优先级：高**
**预计工作量：2.5-3.5小时**

#### 任务分解

**任务3.1：后端API增强（1小时）**
- [ ] 修改 `get-views-status` API，增加 `has_content` 字段
- [ ] 检查每个视角的处理结果是否存在且非空
- [ ] 在 `ViewStatusItem` schema 中增加 `has_content: bool` 字段
- [ ] 更新 `backend/app/schemas/document.py`

**任务3.2：前端条件渲染（1.5小时）**
- [ ] 修改 `PerspectiveSelector.tsx`
- [ ] 检查 `viewsStatus.views_status[view].has_content`
- [ ] 如果 `has_content === false`，不显示该视角的切换按钮
- [ ] 或者显示但置灰，提示"该视角暂无内容"

**任务3.3：测试验证（0.5小时）**
- [ ] 测试单视角文档（只生成一个视角）
- [ ] 测试多视角文档（部分视角失败）
- [ ] 测试空结果场景

**文件清单：**
- `backend/app/api/v1/documents.py` - 修改 `get_views_status`
- `backend/app/schemas/document.py` - 增加 `has_content` 字段
- `frontend/src/components/PerspectiveSelector.tsx` - 条件渲染逻辑

---

### 需求2.1：根据视角决定展示哪些模块

**优先级：高**
**预计工作量：5-7小时**

#### 任务分解

**任务2.1.1：后端进度更新增强（2-3小时）**
- [ ] 修改 `update_progress` 函数，支持传递视角信息
- [ ] 在文档处理开始后，尽快调用视角检测（已有 `recommend-views` API）
- [ ] 在进度更新消息中增加 `enabled_views` 和 `primary_view` 字段
- [ ] 修改 `backend/app/tasks/document_processing.py` 中的进度更新逻辑
- [ ] 确保在视角检测完成后立即更新进度（包含视角信息）

**任务2.1.2：前端动态模块渲染（2-3小时）**
- [ ] 修改 `Progress.tsx`，接收视角信息
- [ ] 从进度响应中提取 `enabled_views` 和 `primary_view`
- [ ] 根据 `enabled_views` 动态渲染对应的模块占位符
- [ ] 创建模块占位符组件：
  - Learning View → "学习路径"模块占位符
  - Q&A View → "关键问题"模块占位符
  - System View → "系统组件"模块占位符
- [ ] 使用骨架屏（Skeleton）或加载动画

**任务2.1.3：WebSocket/轮询支持（1小时）**
- [ ] 如果使用WebSocket，确保进度消息包含视角信息
- [ ] 如果使用轮询，确保 `get-progress` API 返回视角信息
- [ ] 测试实时更新

**任务2.1.4：测试验证（1小时）**
- [ ] 测试单视角文档（只显示一个模块）
- [ ] 测试多视角文档（显示多个模块）
- [ ] 测试视角检测失败场景

**文件清单：**
- `backend/app/tasks/document_processing.py` - 进度更新逻辑
- `backend/app/api/v1/documents.py` - 进度API响应
- `backend/app/schemas/document.py` - 进度响应Schema
- `frontend/src/pages/Progress.tsx` - 动态模块渲染
- `frontend/src/components/ProgressModules.tsx` - 新建模块占位符组件

---

### 需求2.3：过程性反馈（Progressive Disclosure）

**优先级：中高**
**预计工作量：7-10小时**

#### 任务分解

**任务2.3.1：后端增量保存逻辑（3-4小时）**
- [ ] 修改 `process_view_independently` 支持增量保存
- [ ] 在处理过程中，分阶段保存部分结果
  - Learning View：先保存"前置条件"，再保存"学习路径"，最后保存"方法建议"
  - Q&A View：先保存"内容总结"，再保存"问题列表"，最后保存"答案提取"
  - System View：先保存"配置流程"，再保存"组件视图"，最后保存"白话串讲"
- [ ] 使用数据库事务确保数据一致性
- [ ] 每次保存后更新 `ProcessingResult` 的 `result_data` 字段（部分结果）

**任务2.3.2：前端实时获取和展示（3-4小时）**
- [ ] 在 `Progress.tsx` 中，实时获取部分结果
- [ ] 使用轮询或WebSocket获取特定视角的部分结果
- [ ] 调用 `documentsApi.getResult(documentId, view='learning')` 获取特定视角的部分结果
- [ ] 当某个模块有数据时，立即展开显示
- [ ] 使用动画效果（展开/收起）提升体验
- [ ] 显示"正在生成..."状态

**任务2.3.3：UI动画和交互（1小时）**
- [ ] 实现展开/收起动画
- [ ] 实现内容渐入效果
- [ ] 优化加载状态显示

**任务2.3.4：测试验证（1-2小时）**
- [ ] 测试增量保存的数据一致性
- [ ] 测试前端实时更新
- [ ] 测试多个视角同时处理的情况
- [ ] 测试处理失败时的回滚

**文件清单：**
- `backend/app/tasks/view_processing_helper.py` - 增量保存逻辑
- `backend/app/tasks/document_processing.py` - 调用增量保存
- `frontend/src/pages/Progress.tsx` - 实时获取和展示
- `frontend/src/components/ProgressiveModule.tsx` - 新建渐进式模块组件

---

## 第三阶段：高级功能（可选）

### 需求2.2：流式生成（Streaming Generation）

**优先级：低（可选）**
**预计工作量：14-21小时**

#### 任务分解

**任务2.2.1：后端流式AI调用（8-12小时）**
- [ ] 修改 `AIService` 支持流式响应
- [ ] 实现 Server-Sent Events (SSE) 端点
- [ ] 或增强现有WebSocket支持流式内容
- [ ] 修改 `document_processing.py` 中的AI调用逻辑
- [ ] 实现流式内容的分块保存

**任务2.2.2：前端流式接收（4-6小时）**
- [ ] 使用 SSE 或 WebSocket 接收流式数据
- [ ] 实时更新UI，逐字或逐块显示内容
- [ ] 处理连接断开、重连等异常情况
- [ ] 实现打字机效果或逐块显示

**任务2.2.3：测试和优化（2-3小时）**
- [ ] 测试流式传输的稳定性
- [ ] 优化网络异常处理
- [ ] 性能测试和优化

**注意：** 此功能需要较大改动，建议先验证其他功能的效果后再考虑实施。

---

## 实施顺序建议

### 立即开始（本周）
1. ✅ **需求1**：首页历史记录（已完成）
2. **需求3**：隐藏空视角按钮（2.5-3.5小时）

### 第二阶段（下周）
3. **需求2.1**：根据视角展示模块（5-7小时）
4. **需求2.3**：过程性反馈（7-10小时）

### 第三阶段（后续迭代）
5. **需求2.2**：流式生成（14-21小时，可选）

---

## 技术风险

### 高风险
- **需求2.2（流式生成）**：需要修改AI服务调用方式，可能影响现有稳定性

### 中风险
- **需求2.3（过程性反馈）**：需要确保增量保存不影响数据一致性
- **需求2.1（动态模块）**：需要确保视角检测的及时性

### 低风险
- **需求3（隐藏按钮）**：改动小，风险低
- **需求1（历史记录）**：已完成，已验证

---

## 测试策略

### 单元测试
- 后端API的视角检测逻辑
- 前端组件的条件渲染逻辑
- 增量保存的数据一致性

### 集成测试
- 端到端的文档处理流程
- 多视角文档的处理
- 实时更新的准确性

### 用户体验测试
- 页面加载速度
- 交互流畅性
- 错误处理

---

## 依赖关系

```
需求1（历史记录）
  └─ 已完成 ✅

需求3（隐藏按钮）
  └─ 依赖：views-status API
  └─ 独立实施，无阻塞

需求2.1（动态模块）
  └─ 依赖：视角检测API
  └─ 依赖：进度更新API
  └─ 建议在需求3之后实施

需求2.3（过程性反馈）
  └─ 依赖：需求2.1（需要模块占位符）
  └─ 依赖：增量保存逻辑
  └─ 建议在需求2.1之后实施

需求2.2（流式生成）
  └─ 独立功能，可选
  └─ 建议最后实施
```

---

## 里程碑

### 里程碑1：快速实现（已完成 ✅）
- ✅ 需求1：首页历史记录

### 里程碑2：核心功能（预计1-2周）
- [ ] 需求3：隐藏空视角按钮
- [ ] 需求2.1：根据视角展示模块
- [ ] 需求2.3：过程性反馈

### 里程碑3：高级功能（可选，预计2-3周）
- [ ] 需求2.2：流式生成

---

## 下一步行动

1. **立即开始**：实施需求3（隐藏空视角按钮）
2. **准备阶段**：设计需求2.1的模块占位符UI
3. **技术调研**：评估需求2.2的流式生成方案（SSE vs WebSocket）

---

## 更新记录

- 2025-12-24：创建实施计划
- 2025-12-24：需求1已完成，更新状态

