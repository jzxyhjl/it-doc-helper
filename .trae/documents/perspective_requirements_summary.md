# 基于视角的文档分类系统 - 需求总结

## 一、核心需求概述

将文档"类型"概念降级为"视角"，实现多视角处理、快速切换、主次视角识别等功能，提升系统的灵活性和用户体验。

## 二、需求清单

### 需求 1：视角重命名（核心重构）

**优先级**：P0

**需求描述**：
- 将三种结构重新命名（对系统，不是对用户）
- 技术文档结构 → **学习视角（Learning View）**
- 面试题结构 → **问答视角（Q&A View）**
- 架构文档结构 → **系统视角（System View）**

**验收标准**：
1. When 系统内部处理时，应当使用新的视角名称（learning/qa/system）
2. When 数据库存储时，应当保存新的视角名称
3. When API返回结果时，应当使用新的视角名称
4. When 向后兼容时，应当支持类型到视角的映射

**价值**：字段命名更合理，语义更清晰，代码可读性提升

---

### 需求 2：多视角输出容器

**优先级**：P0

**需求描述**：
- 文档处理结果改成"多视角输出容器"
- 不用统一字段，只要包一层
- 不是每个文档都有所有view，检测到哪些就生成哪些

**验收标准**：
1. When 文档处理完成时，系统应当返回多视角输出容器结构
2. When 容器包含多个view时，每个view应当保持原生结构（不统一）
3. When 容器meta信息中，应当包含enabled_views列表（检测到哪些就生成哪些）
4. When 查询结果时，应当能够从容器中提取指定view的结果

**容器结构**：
```json
{
  "views": {
    "learning": {...原技术文档结构...},
    "qa": {...原面试题结构...},
    "system": {...原架构文档结构...}
  },
  "meta": {
    "enabled_views": ["learning", "system"],
    "primary_view": "learning",
    "confidence": {...}
  }
}
```

---

### 需求 3：主次视角识别机制

**优先级**：P0

**需求描述**：
- 识别主视角（默认view）和次视角（可选view）
- 支持强双视角文档（两个视角得分都 >= 0.5）
- 主类型 → 默认 view，次特征 → 可选 view

**验收标准**：
1. When 文档上传时，系统应当分析文档内容特征，推荐主视角和次视角
2. When 文档是 Q&A 结构时，系统应当推荐"问答视角"（主或次）
3. When 文档强调系统组件关系时，系统应当推荐"系统视角"（主或次）
4. When 文档强调使用流程时，系统应当推荐"学习视角"（主或次）
5. When 文档同时包含多种明显特征时，系统应当标记一个主推荐视角，并提示一个或多个可选视角（次视角）
6. When 文档是"强双视角文档"时，系统应当识别两个主视角，并允许用户选择任一视角处理

**分类逻辑**：
- 判断为技术文档 → 默认 learning view → 如果组件关键词多，再加 system view
- 判断为面试题文档 → 默认 qa view → 如果包含学习路径，再加 learning view
- 判断为架构文档 → 默认 system view → 如果包含教程内容，再加 learning view

---

### 需求 4：快速切换视角（复用中间结果）

**优先级**：P0

**需求描述**：
- 切换视角时复用中间结果（内容提取、段落切分、预处理等）
- 仅重新处理AI部分（根据新视角调用对应处理器）
- 5秒内完成切换，避免用户以为是bug

**验收标准**：
1. When 用户切换视角时，系统应当复用已有的中间结果
2. When 中间结果存在时，系统应当在5秒内返回新视角的结果
3. When 中间结果不存在时，系统应当全量处理，但明确告知用户预计等待时间
4. When 切换视角时，系统应当显示"正在切换视角..."提示，避免用户以为是bug
5. When 切换完成时，系统应当保存新视角的结果到容器中

**中间结果存储**：
- 内容提取结果
- 预处理后的内容
- 段落切分结果
- 元数据（文件类型、大小等）

---

### 需求 5：启用多个视角处理

**优先级**：P0

**需求描述**：
- 从"选一种"变成"启用哪些"
- 可以同时启用多个视角进行处理
- 检测到哪些特征，就生成哪些view

**验收标准**：
1. When 用户上传文档时，系统应当支持指定多个视角（perspectives参数，逗号分隔）
2. When 系统自动推荐时，应当根据特征得分启用多个视角（得分 >= 0.3）
3. When 处理多个视角时，系统应当并行处理，生成多个结果
4. When 处理完成时，系统应当将所有结果保存到多视角输出容器中

**示例**：
- `perspectives=learning,system` → 同时启用学习视角和系统视角
- 自动检测：learning得分0.85，system得分0.65 → 启用两个视角

---

### 需求 6：保留并优化分类机制

**优先级**：P0.5

**需求描述**：
- 原分类机制还能用，而且更好用了
- 主类型 → 默认 view
- 次特征 → 可选 view

**验收标准**：
1. When 系统识别文档类型时，应当保留原有的类型识别逻辑
2. When 确定主类型后，应当映射到默认view
3. When 检测到次特征时，应当添加到可选view列表
4. When 类型和视角映射时，应当支持向后兼容

**映射关系**：
- `technical` → `learning` view
- `interview` → `qa` view
- `architecture` → `system` view

---

### 需求 7：视角作为UI初始状态

**优先级**：P1

**需求描述**：
- 在UI中显示推荐的视角作为初始状态
- 显示主视角和次视角
- 支持视角切换

**验收标准**：
1. When 用户查看文档结果时，UI应当显示当前使用的视角
2. When 用户查看历史记录时，UI应当显示文档使用的视角
3. When 用户查看推荐文档时，UI应当显示推荐的视角
4. When 视角信息缺失时，UI应当显示默认视角（学习视角）

---

### 需求 8：降低类型权重

**优先级**：P1

**需求描述**：
- 将"类型"概念降级为内部处理标识
- 用户界面优先显示视角信息
- 保留类型用于向后兼容

**验收标准**：
1. When 系统内部处理时，类型信息应当保留用于兼容性
2. When 用户界面显示时，应当优先显示视角信息
3. When API返回结果时，应当包含视角信息
4. When 数据库存储时，应当同时保存类型和视角信息

---

### 需求 9：向后兼容性

**优先级**：P2

**需求描述**：
- 保持向后兼容，确保现有功能不受影响
- 支持历史数据的类型到视角映射

**验收标准**：
1. When 处理历史文档时，系统应当能够根据类型推断默认视角
2. When API调用未指定视角时，系统应当使用推荐的视角
3. When 数据库查询时，系统应当能够同时支持类型和视角筛选
4. When 前端显示时，系统应当能够处理缺少视角信息的旧数据

---

## 三、视角定义

### 学习视角（Learning View）
- **原名称**：技术文档结构
- **识别特征**：使用流程、操作步骤、学习路径、入门指南
- **处理方式**：使用 TechnicalProcessor
- **输出结构**：prerequisites, learning_path, learning_methods, related_technologies

### 问答视角（Q&A View）
- **原名称**：面试题结构
- **识别特征**：Q&A 结构、问题-答案对、选择题、问答题
- **处理方式**：使用 InterviewProcessor
- **输出结构**：summary, generated_questions, extracted_answers

### 系统视角（System View）
- **原名称**：架构文档结构
- **识别特征**：系统组件关系、模块依赖、服务架构、部署配置
- **处理方式**：使用 ArchitectureProcessor
- **输出结构**：config_steps, components, architecture_view, plain_explanation, checklist, related_technologies

---

## 四、优先级总结

### P0（核心功能）
1. ✅ 视角重命名（learning/qa/system）
2. ✅ 多视角输出容器
3. ✅ 主次视角识别机制
4. ✅ 快速切换视角（复用中间结果）
5. ✅ 启用多个视角处理

### P0.5（重要优化）
6. ✅ 保留并优化分类机制

### P1（用户体验）
7. ⚠️ 视角作为UI初始状态
8. ⚠️ 降低类型权重

### P2（兼容性）
9. ⚠️ 向后兼容性

---

## 五、关键技术点

### 5.1 多视角输出容器结构
```json
{
  "views": {
    "learning": {...原生结构...},
    "qa": {...原生结构...},
    "system": {...原生结构...}
  },
  "meta": {
    "enabled_views": ["learning", "system"],
    "primary_view": "learning",
    "confidence": {
      "learning": 0.85,
      "system": 0.65,
      "qa": 0.15
    }
  }
}
```

### 5.2 分类机制优化
- 主类型 → 默认 view
- 次特征 → 可选 view
- 检测到哪些就生成哪些

### 5.3 快速切换机制
- 复用中间结果（内容提取、段落切分、预处理）
- 仅重新处理AI部分
- 5秒内完成

### 5.4 中间结果存储
- 新增 `document_intermediate_results` 表
- 存储内容提取、预处理、段落切分等中间数据

---

## 六、实施影响

### 6.1 数据库变更
- 新增 `document_intermediate_results` 表
- 修改 `document_types` 表（添加 primary_view, enabled_views 字段）
- 修改 `processing_results` 表（result_data 改为多视角容器结构）

### 6.2 API变更
- 上传接口：支持 `views` 参数（多个视角）
- 新增接口：`/documents/{id}/recommend-views`（推荐主次视角）
- 新增接口：`/documents/{id}/switch-view`（快速切换视角）
- 结果接口：返回多视角输出容器

### 6.3 前端变更
- 视角选择组件：使用新名称（learning/qa/system）
- 结果展示：从容器中提取view
- UI文案：学习视角/问答视角/系统视角

### 6.4 代码变更
- 视角注册表：ViewRegistry（替代 PerspectiveRegistry）
- 分类器：DocumentViewClassifier（替代 DocumentClassifier）
- 容器类：MultiViewOutputContainer
- 处理器：保持原有处理器，通过注册表映射

---

**文档版本**：v1.0  
**创建时间**：2025-12-21  
**最后更新**：2025-12-21

