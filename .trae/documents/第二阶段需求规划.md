# IT学习辅助系统 - 第二阶段需求规划

## 一、需求背景

基于MVP功能的成功实现，第二阶段将专注于**系统学习能力增强**和**知识库构建**，通过已有技术栈（PostgreSQL + pgvector）实现文档相似度搜索、知识关联和智能推荐功能，无需引入新的技术栈。

---

## 二、第二阶段功能范围

### 2.1 知识库构建（核心功能）

#### 2.1.1 文档向量化存储
**优先级**: 高
**描述**: 将处理过的文档内容转换为向量并存储，支持相似度搜索

**功能点**:
- [ ] 启用PostgreSQL的pgvector扩展
- [ ] 文档内容向量化（使用文本嵌入模型）
- [ ] 向量数据存储到`system_learning_data`表
- [ ] 向量索引创建（提升搜索性能）

**技术实现**:
- 使用OpenAI兼容的嵌入API（DeepSeek Embeddings或类似服务）
- 在`system_learning_data`表中添加`embedding`字段（vector类型）
- 创建向量索引（IVFFlat或HNSW）
- 文档处理完成后自动生成向量

**验收标准**:
1. When 文档处理完成后，系统应当自动生成文档内容的向量表示
2. When 向量生成成功后，系统应当将向量存储到数据库
3. When 存储向量时，系统应当创建向量索引以提升搜索性能
4. When 向量生成失败时，系统应当记录错误但不影响文档处理流程

---

#### 2.1.2 相似文档推荐
**优先级**: 高
**描述**: 基于向量相似度，为用户推荐与当前文档相似的历史文档

**功能点**:
- [ ] 相似度搜索API实现
- [ ] 相似文档列表展示
- [ ] 相似度分数显示
- [ ] 相似文档快速跳转

**技术实现**:
- 使用pgvector的余弦相似度搜索（`<=>` 操作符）
- API端点：`GET /api/v1/documents/{document_id}/similar`
- 返回Top-K相似文档（默认K=5）
- 前端在结果页面展示"相似文档"区域

**验收标准**:
1. When 用户查看文档处理结果时，系统应当显示相似文档列表（最多5个）
2. When 显示相似文档时，系统应当显示相似度分数（0-1之间）
3. When 用户点击相似文档时，系统应当跳转到该文档的处理结果页面
4. When 没有相似文档时，系统应当显示"暂无相似文档"提示

---

#### 2.1.3 知识关联分析
**优先级**: 中
**描述**: 分析文档之间的知识关联关系，构建知识网络

**功能点**:
- [ ] 文档关键词提取
- [ ] 关键词关联分析
- [ ] 知识关联图谱（文字描述）
- [ ] 相关知识点推荐

**技术实现**:
- 使用AI提取文档关键词
- 基于关键词和向量相似度分析关联关系
- 生成关联关系描述（文字形式）
- API端点：`GET /api/v1/documents/{document_id}/related-knowledge`

**验收标准**:
1. When 文档处理完成后，系统应当提取文档的关键词
2. When 用户查看文档结果时，系统应当显示相关知识关联信息
3. When 显示知识关联时，系统应当列出相关的知识点和文档
4. When 没有知识关联时，系统应当显示"暂无关联知识"提示

---

### 2.2 系统学习能力增强

#### 2.2.1 处理结果质量评估
**优先级**: 中
**描述**: 基于历史处理数据，评估和优化处理结果质量

**功能点**:
- [ ] 处理结果质量指标收集
- [ ] 质量评估算法（基于内容长度、结构完整性等）
- [ ] 质量报告生成
- [ ] 低质量结果标记

**技术实现**:
- 在`system_learning_data`表中记录质量指标
- 质量评估规则：
  - 内容完整性（是否有缺失字段）
  - 内容长度（是否过短）
  - 结构规范性（是否符合预期格式）
- 后台任务定期评估历史数据

**验收标准**:
1. When 文档处理完成后，系统应当自动评估处理结果质量
2. When 质量评估完成时，系统应当记录质量分数（0-100）
3. When 质量分数低于阈值（如60分）时，系统应当在结果中标记"质量待优化"
4. When 查看历史记录时，系统应当显示质量分数

---

#### 2.2.2 处理模式学习
**优先级**: 中
**描述**: 从历史处理数据中学习文档处理模式，优化识别和处理策略

**功能点**:
- [ ] 文档类型识别准确率统计
- [ ] 处理耗时分析
- [ ] 常见错误模式识别
- [ ] 处理策略优化建议

**技术实现**:
- 在`system_learning_data`表中记录处理模式数据
- 定期分析历史数据，生成统计报告
- 识别常见错误模式（如类型识别错误、处理超时等）
- 生成优化建议（管理员查看）

**验收标准**:
1. When 系统运行一段时间后，系统应当能够统计文档类型识别准确率
2. When 统计处理耗时时，系统应当识别处理时间异常长的文档类型
3. When 发现常见错误模式时，系统应当记录到日志供管理员查看
4. When 生成优化建议时，系统应当提供具体的改进方向

---

### 2.3 文档覆盖处理优化

#### 2.3.1 同名文档覆盖机制
**优先级**: 高
**描述**: 当上传同名文档时，自动覆盖旧文档，避免重复存储

**功能点**:
- [ ] 文档名重复检测
- [ ] 旧文档自动删除（包括文件、数据库记录）
- [ ] 新文档自动处理
- [ ] 覆盖提示信息

**技术实现**:
- 在上传API中检测文件名是否已存在
- 如果存在，删除旧文档的所有关联数据：
  - 删除文件系统中的文件
  - 删除`documents`表记录
  - 级联删除`processing_results`、`processing_tasks`、`document_types`、`system_learning_data`
- 创建新文档记录并触发处理

**验收标准**:
1. When 用户上传与已有文档同名的文件时，系统应当自动删除旧文档
2. When 删除旧文档时，系统应当删除所有关联数据（文件、数据库记录）
3. When 覆盖完成后，系统应当自动开始新文档的处理流程
4. When 覆盖发生时，系统应当向用户显示"已覆盖同名文档"的提示信息

---

#### 2.3.2 智能重新处理判断
**优先级**: 低
**描述**: 判断同名文档是否需要重新处理（基于文件内容变化）

**功能点**:
- [ ] 文件内容哈希计算
- [ ] 内容变化检测
- [ ] 自动重新处理触发
- [ ] 跳过处理优化（内容未变化时）

**技术实现**:
- 计算文件内容的MD5或SHA256哈希值
- 在`documents`表中存储`content_hash`字段
- 上传同名文档时，比较哈希值
- 如果哈希值相同，跳过处理，直接返回旧结果
- 如果哈希值不同，执行覆盖和重新处理

**验收标准**:
1. When 上传文档时，系统应当计算文件内容的哈希值
2. When 上传同名文档且内容哈希值相同时，系统应当跳过处理并返回旧结果
3. When 上传同名文档且内容哈希值不同时，系统应当执行覆盖和重新处理
4. When 跳过处理时，系统应当向用户显示"文档内容未变化，使用已有结果"的提示

---

### 2.4 个人学习空间（简化版）

#### 2.4.1 学习路径跟踪
**优先级**: 中
**描述**: 基于用户上传的文档，自动生成个人学习路径

**功能点**:
- [ ] 用户文档类型统计
- [ ] 学习路径自动生成
- [ ] 学习进度可视化（简单图表）
- [ ] 学习建议推荐

**技术实现**:
- 统计用户上传的文档类型分布
- 基于文档类型生成学习路径建议
- 使用简单的文字描述展示学习路径
- API端点：`GET /api/v1/learning/path`

**验收标准**:
1. When 用户有处理历史时，系统应当能够统计文档类型分布
2. When 查看学习路径时，系统应当显示基于历史文档的学习建议
3. When 显示学习路径时，系统应当以清晰的文字描述展示
4. When 没有处理历史时，系统应当显示"暂无学习路径"提示

---

#### 2.4.2 学习数据分析
**优先级**: 中
**描述**: 分析用户的学习数据，提供学习洞察

**功能点**:
- [ ] 学习时长统计（基于处理时间）
- [ ] 文档类型分布统计
- [ ] 学习趋势分析（时间维度）
- [ ] 知识掌握度评估（基于文档类型）

**技术实现**:
- 基于`processing_results`和`documents`表统计学习数据
- 生成简单的统计报告（文字+数字）
- API端点：`GET /api/v1/learning/statistics`
- 前端展示统计卡片

**验收标准**:
1. When 用户查看学习统计时，系统应当显示处理文档总数
2. When 显示学习统计时，系统应当显示各类型文档的数量分布
3. When 显示学习趋势时，系统应当显示最近一段时间的文档处理趋势
4. When 没有处理历史时，系统应当显示"暂无统计数据"提示

---

## 三、技术实现要点

### 3.1 向量化技术选型

**方案选择**:
- **嵌入模型**: 使用DeepSeek API（优先使用Embeddings API，如不支持则使用Chat API生成向量）
- **API调用**: 复用现有的`AIService`配置（`DEEPSEEK_API_KEY`和`DEEPSEEK_API_BASE`）
- **向量维度**: 根据DeepSeek API返回的维度确定（需要实际测试）
- **相似度计算**: 余弦相似度（pgvector的`<=>`操作符）
- **索引类型**: IVFFlat（适合小规模）或HNSW（适合大规模）

**实现方式**:
1. **优先方案**：如果DeepSeek提供Embeddings API端点
   - 使用`openai` SDK的`client.embeddings.create()`方法
   - 配置`base_url`为DeepSeek API地址
   
2. **备选方案**：如果DeepSeek不提供Embeddings API
   - 使用Chat API + 特殊prompt要求返回向量表示
   - 或使用本地嵌入模型（如sentence-transformers）作为备选

**数据库变更**:
```sql
-- 启用pgvector扩展
CREATE EXTENSION IF NOT EXISTS vector;

-- 在system_learning_data表中添加embedding字段
ALTER TABLE system_learning_data 
ADD COLUMN embedding vector(1536);

-- 创建向量索引
CREATE INDEX ON system_learning_data 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);
```

### 3.2 文件哈希计算

**实现方式**:
- 使用Python的`hashlib`库计算文件MD5或SHA256
- 在文档上传时计算并存储
- 用于同名文档的内容变化检测

### 3.3 无需新增技术栈

**已有技术栈即可实现**:
- ✅ PostgreSQL + pgvector（已在设计文档中规划）
- ✅ Python标准库（hashlib用于哈希计算）
- ✅ 现有AI服务（DeepSeek API，用于嵌入向量生成）
- ✅ 现有前端技术栈（React + TailwindCSS）

---

## 四、实施计划

### 阶段一：知识库构建（2-3周）

**任务1**: pgvector扩展启用和数据库迁移
- 创建数据库迁移脚本
- 启用pgvector扩展
- 添加embedding字段
- 创建向量索引

**任务2**: 文档向量化服务实现
- 集成嵌入API（DeepSeek或兼容服务）
- 实现向量生成服务
- 在文档处理流程中集成向量生成
- 向量数据存储到数据库

**任务3**: 相似文档搜索API实现
- 实现相似度搜索算法
- 创建相似文档API端点
- 编写单元测试

**任务4**: 前端相似文档展示
- 在结果页面添加"相似文档"区域
- 实现相似文档列表组件
- 实现跳转功能

### 阶段二：文档覆盖处理（1周）

**任务5**: 同名文档检测和覆盖
- 实现文件名重复检测
- 实现旧文档删除逻辑
- 集成到上传API
- 添加覆盖提示

**任务6**: 内容哈希和智能判断（可选）
- 实现文件内容哈希计算
- 实现内容变化检测
- 实现跳过处理优化

### 阶段三：系统学习能力（2周）

**任务7**: 处理结果质量评估
- 实现质量评估算法
- 集成到文档处理流程
- 在结果中显示质量分数

**任务8**: 处理模式学习
- 实现统计数据收集
- 实现分析报告生成
- 创建管理员查看接口

### 阶段四：个人学习空间（1-2周）

**任务9**: 学习路径跟踪
- 实现文档类型统计
- 实现学习路径生成
- 创建学习路径API
- 前端展示学习路径

**任务10**: 学习数据分析
- 实现统计数据收集
- 创建统计API
- 前端展示统计卡片

---

## 五、验收标准总结

### 核心功能验收

1. **向量化存储**: 文档处理完成后自动生成并存储向量
2. **相似文档推荐**: 在结果页面显示相似文档列表（Top-5）
3. **文档覆盖**: 同名文档自动覆盖，删除旧数据
4. **质量评估**: 处理结果自动评估质量分数
5. **学习路径**: 基于历史文档生成个人学习路径
6. **学习统计**: 显示学习数据统计信息

### 性能要求

1. 向量生成时间：< 5秒（单文档）
2. 相似度搜索响应时间：< 500ms
3. 文档覆盖处理时间：< 2秒

### 数据要求

1. 向量数据存储：支持至少1000个文档的向量存储
2. 相似度搜索准确率：Top-5相似文档的相关性 > 70%

---

## 六、风险与注意事项

1. **pgvector扩展兼容性**: 确保PostgreSQL版本支持pgvector（建议12+）
2. **嵌入API可用性**: 确保DeepSeek或其他嵌入API稳定可用
3. **向量维度选择**: 根据嵌入模型确定向量维度，避免后续迁移
4. **索引性能**: 根据数据规模选择合适的索引类型和参数
5. **文件哈希计算**: 大文件哈希计算可能耗时，考虑异步处理

---

**文档版本**: v1.0
**创建时间**: 2025-12-09
**最后更新**: 2025-12-09

