# 待实现功能清单

## 📋 总体状态

### ✅ 已完成功能
1. **需求1：首页历史记录展示** ✅
   - 首页显示最近5条历史记录
   - 右上角快速入口
   - 独立区块展示

2. **需求3：隐藏空视角切换按钮** ✅
   - 后端API增加 `has_content` 字段
   - 前端根据 `has_content` 条件渲染
   - 空视角不显示切换按钮

3. **视角系统重构** ✅
   - 数据库迁移完成
   - 多视角处理逻辑实现
   - API接口更新完成
   - 前端UI更新完成

4. **需求2.1：根据视角决定展示哪些模块** ✅
   - 后端进度更新支持视角信息（enabled_views, primary_view）
   - 前端动态模块渲染（ProgressModuleSkeleton组件）
   - 视角检测完成后立即显示模块占位符

5. **需求2.3：过程性反馈（简化版）** ✅
   - 后端增量保存辅助函数（_save_incremental_result）
   - 前端渐进式模块组件（ProgressiveModule）
   - 自动轮询获取部分结果（每2秒）
   - 有内容时自动展开显示

6. **结果导出功能** ✅
   - 后端导出服务（ResultExporter）
   - 支持Markdown格式导出
   - 前端导出按钮和下载功能
   - 支持三种视角的导出

---

## 🚧 待实现功能

### 优先级：高

#### 1. 需求2.1：根据视角决定展示哪些模块

**状态**：待实施  
**优先级**：高  
**预计工作量**：5-7小时  
**依赖**：无

**功能描述**：
在进度页面，根据检测到的视角动态展示对应的模块占位符，而不是固定显示所有模块。

**任务分解**：
- [ ] **任务2.1.1：后端进度更新增强（2-3小时）**
  - 修改 `update_progress` 函数，支持传递视角信息
  - 在文档处理开始后，尽快调用视角检测
  - 在进度更新消息中增加 `enabled_views` 和 `primary_view` 字段
  - 修改 `backend/app/tasks/document_processing.py` 中的进度更新逻辑

- [ ] **任务2.1.2：前端动态模块渲染（2-3小时）**
  - 修改 `Progress.tsx`，接收视角信息
  - 从进度响应中提取 `enabled_views` 和 `primary_view`
  - 根据 `enabled_views` 动态渲染对应的模块占位符
  - 创建模块占位符组件（骨架屏）

- [ ] **任务2.1.3：WebSocket/轮询支持（1小时）**
  - 确保进度消息包含视角信息
  - 测试实时更新

- [ ] **任务2.1.4：测试验证（1小时）**
  - 测试单视角文档
  - 测试多视角文档
  - 测试视角检测失败场景

**相关文件**：
- `backend/app/tasks/document_processing.py`
- `backend/app/api/v1/documents.py`
- `backend/app/schemas/document.py`
- `frontend/src/pages/Progress.tsx`
- `frontend/src/components/ProgressModules.tsx`（新建）

---

#### 2. 需求2.3：过程性反馈（Progressive Disclosure）

**状态**：待实施  
**优先级**：中高  
**预计工作量**：7-10小时  
**依赖**：需求2.1（需要模块占位符）

**功能描述**：
在处理过程中，分阶段保存部分结果，前端实时获取并展示，让用户看到处理进度。

**任务分解**：
- [ ] **任务2.3.1：后端增量保存逻辑（3-4小时）**
  - 修改 `process_view_independently` 支持增量保存
  - 分阶段保存部分结果：
    - Learning View：先保存"前置条件"，再保存"学习路径"，最后保存"方法建议"
    - Q&A View：先保存"内容总结"，再保存"问题列表"，最后保存"答案提取"
    - System View：先保存"配置流程"，再保存"组件视图"，最后保存"白话串讲"
  - 使用数据库事务确保数据一致性
  - 每次保存后更新 `ProcessingResult` 的 `result_data` 字段

- [ ] **任务2.3.2：前端实时获取和展示（3-4小时）**
  - 在 `Progress.tsx` 中，实时获取部分结果
  - 使用轮询或WebSocket获取特定视角的部分结果
  - 调用 `documentsApi.getResult(documentId, view='learning')` 获取特定视角的部分结果
  - 当某个模块有数据时，立即展开显示
  - 使用动画效果（展开/收起）提升体验

- [ ] **任务2.3.3：UI动画和交互（1小时）**
  - 实现展开/收起动画
  - 实现内容渐入效果
  - 优化加载状态显示

- [ ] **任务2.3.4：测试验证（1-2小时）**
  - 测试增量保存的数据一致性
  - 测试前端实时更新
  - 测试多个视角同时处理的情况
  - 测试处理失败时的回滚

**相关文件**：
- `backend/app/tasks/view_processing_helper.py`
- `backend/app/tasks/document_processing.py`
- `frontend/src/pages/Progress.tsx`
- `frontend/src/components/ProgressiveModule.tsx`（新建）

---

### 优先级：低（可选）

#### 1. 需求2.2：流式生成（Streaming Generation）

**状态**：待实施（可选）  
**优先级**：低  
**预计工作量**：14-21小时  
**依赖**：无

**功能描述**：
实现真正的流式生成，让用户看到内容逐字或逐块生成，而不是等待完成后一次性显示。

**任务分解**：
- [ ] **任务2.2.1：后端流式AI调用（8-12小时）**
  - 修改 `AIService` 支持流式响应
  - 实现 Server-Sent Events (SSE) 端点
  - 或增强现有WebSocket支持流式内容
  - 修改 `document_processing.py` 中的AI调用逻辑
  - 实现流式内容的分块保存

- [ ] **任务2.2.2：前端流式接收（4-6小时）**
  - 使用 SSE 或 WebSocket 接收流式数据
  - 实时更新UI，逐字或逐块显示内容
  - 处理连接断开、重连等异常情况
  - 实现打字机效果或逐块显示

- [ ] **任务2.2.3：测试和优化（2-3小时）**
  - 测试流式传输的稳定性
  - 优化网络异常处理
  - 性能测试和优化

**注意**：此功能需要较大改动，建议先验证其他功能的效果后再考虑实施。

**相关文件**：
- `backend/app/services/ai_service.py`
- `backend/app/api/v1/documents.py`（新增SSE端点）
- `frontend/src/pages/Progress.tsx`
- `frontend/src/components/StreamingContent.tsx`（新建）

---

## 📊 实施建议

### 立即开始（本周）
1. ✅ **需求1**：首页历史记录（已完成）
2. ✅ **需求3**：隐藏空视角按钮（已完成）

### 第二阶段（下周）
3. **需求2.1**：根据视角展示模块（5-7小时）
   - 为后续功能打基础
   - 提升用户体验

4. **需求2.3**：过程性反馈（7-10小时）
   - 依赖需求2.1
   - 用户体验提升大

### 第三阶段（后续迭代）
5. **需求2.2**：流式生成（14-21小时，可选）
   - 需要评估ROI
   - 技术风险较高

---

## 🔗 依赖关系

```
需求1（历史记录）
  └─ 已完成 ✅

需求3（隐藏按钮）
  └─ 已完成 ✅

需求2.1（动态模块）
  └─ 依赖：视角检测API（已有）
  └─ 依赖：进度更新API（已有）
  └─ 独立实施，无阻塞

需求2.3（过程性反馈）
  └─ 依赖：需求2.1（需要模块占位符）
  └─ 依赖：增量保存逻辑
  └─ 建议在需求2.1之后实施

需求2.2（流式生成）
  └─ 独立功能，可选
  └─ 建议最后实施
```

---

## 📈 工作量估算

| 功能 | 优先级 | 工作量 | 状态 |
|------|--------|--------|------|
| 需求1：首页历史记录 | 高 | 2小时 | ✅ 已完成 |
| 需求3：隐藏空视角按钮 | 高 | 2.5-3.5小时 | ✅ 已完成 |
| 需求2.1：根据视角展示模块 | 高 | 5-7小时 | ✅ 已完成 |
| 需求2.3：过程性反馈 | 中高 | 7-10小时 | ✅ 已完成（简化版） |
| 结果导出功能 | 中 | 3-4小时 | ✅ 已完成 |
| 需求2.2：流式生成 | 低（可选） | 14-21小时 | 🚧 待实施 |

**总计待实施工作量**：14-21小时（仅流式生成）

---

## 🎯 下一步行动

1. **立即开始**：实施需求2.1（根据视角展示模块）
2. **准备阶段**：设计需求2.1的模块占位符UI
3. **技术调研**：评估需求2.2的流式生成方案（SSE vs WebSocket）

---

## 📝 更新记录

- 2025-12-24：创建待实现功能清单
- 2025-12-24：更新已完成功能状态

