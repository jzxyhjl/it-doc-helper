# 文档大小与超时配置分析报告

## 📊 当前系统配置

### 文件大小限制
- **最大上传大小**: 30MB (`UPLOAD_MAX_SIZE`)
- **警告阈值**: 20MB (`FILE_SIZE_WARNING`)
- **文件大小验证**: 在 `DocumentSizeValidator.validate_file_size()`

### 内容长度限制
- **最大内容长度**: 50万字符 (`CONTENT_LENGTH_MAX`)
- **警告阈值**: 30万字符 (`CONTENT_LENGTH_WARNING`)
- **PDF提取限制**: 最大500页，最大50万字符

### 处理时间限制
- **最大处理时间**: 1200秒（20分钟）(`PROCESS_TIME_MAX`)
- **警告阈值**: 900秒（15分钟）(`PROCESS_TIME_WARNING`)
- **动态超时**: 基础20分钟 + 每个额外视角+5分钟，最大25分钟

### Celery任务超时
- **硬超时**: 1800秒（30分钟）(`task_time_limit`)
- **软超时**: 1500秒（25分钟）(`task_soft_time_limit`)

### PDF提取超时
- **默认超时**: 120秒（2分钟）
- **大文件超时**: 180秒（3分钟，>20MB）
- **单页超时**: 5秒

## 🔍 处理时间估算公式

```python
base_time = 30秒
content_factor = (content_length / 10000) * 10
type_factor = {
    "technical": 1.0,
    "interview": 0.8,
    "architecture": 1.2
}
estimated_time = base_time + (content_factor * type_factor)
```

### 示例计算
- **10万字符** (technical): 30 + (10 * 1.0) = **130秒** (2.2分钟)
- **30万字符** (technical): 30 + (30 * 1.0) = **330秒** (5.5分钟)
- **50万字符** (technical): 30 + (50 * 1.0) = **530秒** (8.8分钟)

## ⚠️ 流式生成和多视角的影响

### 流式生成开销
- **时间增加**: 约20-30%（需要逐块推送和显示）
- **示例**: 8.8分钟基础时间 → 约11分钟（+25%）

### 多视角处理
- **单视角**: 基础时间 + 流式开销
- **双视角**: 单视角时间 + 5分钟
- **三视角**: 单视角时间 + 10分钟（但不超过25分钟）

### 实际处理时间示例（50万字符，technical）
- **单视角**: 530秒 + 132秒（流式） = **662秒** (11分钟) ✅
- **双视角**: 662秒 + 300秒 = **962秒** (16分钟) ✅
- **三视角**: 662秒 + 600秒 = **1262秒** (21分钟) ⚠️ 接近20分钟限制

## 📈 文件大小与内容长度关系

### PDF文件估算（保守）
- **假设**: PDF压缩比约10:1，文本提取率约50-70%
- **30MB PDF**: 约50万字符（当前上限）
- **20MB PDF**: 约33万字符
- **10MB PDF**: 约17万字符
- **5MB PDF**: 约8万字符

### 其他格式
- **Word/PPT**: 文本提取率更高，但文件可能包含图片
- **Markdown/TXT**: 1:1对应，文件大小≈内容长度

## 🎯 建议调整方案

### 方案1：保守调整（推荐）
**目标**: 确保大多数文档能在20分钟内完成，避免超时

#### 文件大小限制
- **最大上传**: 保持 **30MB**（合理）
- **警告阈值**: 降低到 **15MB**（更早提醒用户）

#### 内容长度限制
- **最大内容**: 降低到 **40万字符**（减少超时风险）
- **警告阈值**: 降低到 **25万字符**

#### 处理时间限制
- **最大处理时间**: 保持 **1200秒**（20分钟）
- **警告阈值**: 保持 **900秒**（15分钟）

#### 理由
- 40万字符 ≈ 24MB PDF（在30MB限制内）
- 40万字符处理时间：约7.5分钟（单视角）+ 流式开销 = 约9.5分钟
- 双视角：约14.5分钟 ✅
- 三视角：约19.5分钟 ⚠️ 接近但不超过20分钟

### 方案2：激进调整
**目标**: 更严格限制，确保所有文档都能快速完成

#### 文件大小限制
- **最大上传**: 降低到 **20MB**
- **警告阈值**: **10MB**

#### 内容长度限制
- **最大内容**: 降低到 **30万字符**
- **警告阈值**: **20万字符**

#### 处理时间限制
- **最大处理时间**: 保持 **1200秒**
- **警告阈值**: 降低到 **600秒**（10分钟）

#### 理由
- 更快的处理速度
- 更好的用户体验
- 但可能拒绝一些合理的文档

### 方案3：保持现状但优化估算
**目标**: 不改变限制，但优化处理时间估算公式

#### 调整估算公式
考虑流式生成和多视角的开销：

```python
def estimate_processing_time(content_length, doc_type="technical", view_count=1):
    base_time = 30
    content_factor = (content_length / 10000) * 10
    type_factor = {
        "technical": 1.0,
        "interview": 0.8,
        "architecture": 1.2
    }
    
    # 基础时间
    base_estimated = base_time + (content_factor * type_factor.get(doc_type, 1.0))
    
    # 流式生成开销（+25%）
    stream_overhead = base_estimated * 0.25
    
    # 多视角开销（每个额外视角+5分钟）
    multi_view_overhead = (view_count - 1) * 300
    
    return int(base_estimated + stream_overhead + multi_view_overhead)
```

#### 理由
- 更准确的估算
- 不需要改变限制
- 但需要知道视角数量才能准确估算

## 📋 推荐方案：方案1（保守调整）

### 具体调整值

```python
# backend/app/services/document_size_validator.py
FILE_SIZE_WARNING = 15 * 1024 * 1024  # 15MB（从20MB降低）
FILE_SIZE_MAX = 30 * 1024 * 1024      # 30MB（保持）
CONTENT_LENGTH_WARNING = 250000       # 25万字符（从30万降低）
CONTENT_LENGTH_MAX = 400000           # 40万字符（从50万降低）
PROCESS_TIME_WARNING = 900             # 15分钟（保持）
PROCESS_TIME_MAX = 1200               # 20分钟（保持）
```

### 预期效果
- ✅ 减少超时风险
- ✅ 更早提醒用户大文件
- ✅ 保持合理的文档大小支持
- ✅ 大多数文档能在20分钟内完成

### 需要同步更新的地方
1. `backend/app/services/document_size_validator.py` - 阈值定义
2. `frontend/src/components/FileUpload.tsx` - 前端警告阈值（15MB）
3. `backend/app/api/v1/documents.py` - API文档说明

## 🔧 实施建议

1. **先实施方案1**，观察实际处理情况
2. **收集数据**：记录实际处理时间 vs 估算时间
3. **根据数据调整**：如果仍有超时，考虑方案2
4. **优化估算公式**：实施方案3，提高估算准确性

## 📊 监控指标

建议监控以下指标：
- 实际处理时间 vs 估算时间
- 超时率（按文件大小、视角数量分组）
- 实际内容长度 vs 文件大小（PDF提取率）
- 不同文档类型的处理时间分布

