# 需求文档 - AI服务自动回归测试、失败模拟和稳定性监控

## 介绍

为系统增加AI服务的自动化测试和监控能力，确保DeepSeek API调用的稳定性和结果质量。即使现在使用的是DeepSeek API，也需要建立完善的测试和监控机制，以便：
1. 及时发现API调用问题
2. 验证关键场景的处理结果稳定性
3. 模拟API失败场景，验证系统容错能力
4. 持续监控AI处理结果的质量和一致性

---

## 需求 1 - 自动回归测试（关键场景）

### 用户故事：
作为开发团队，我需要系统能够自动运行关键场景的回归测试，以便在每次代码变更后快速验证核心功能是否正常工作。

### 验收标准：

#### 1.1 测试框架搭建
1. When 运行测试命令时，系统应当能够执行所有关键场景的回归测试
2. When 测试执行时，系统应当能够自动验证文档处理流程的完整性
3. When 测试失败时，系统应当提供详细的错误信息和失败原因
4. When 测试通过时，系统应当生成测试报告，包含测试用例、执行时间、通过率等信息

#### 1.2 关键场景覆盖
5. When 运行回归测试时，系统应当测试以下关键场景：
   - 技术文档处理（前置条件、学习路径、学习方法、相关技术）
   - 面试题文档处理（总结、生成问题、提取答案）
   - 架构文档处理（配置流程、组件识别、全景视图、白话串讲、检查清单）
6. When 测试技术文档时，系统应当验证所有必需字段都存在且格式正确
7. When 测试面试题文档时，系统应当验证问题生成和答案提取的完整性
8. When 测试架构文档时，系统应当验证所有处理步骤的结果都存在

#### 1.3 结果验证
9. When 测试执行完成后，系统应当验证处理结果的数据结构完整性
10. When 验证结果时，系统应当检查置信度和来源片段字段是否存在
11. When 验证结果时，系统应当检查关键字段的值是否在合理范围内（如置信度0-100）
12. When 验证结果时，系统应当检查结果内容是否为空或格式错误

#### 1.4 测试数据管理
13. When 运行测试时，系统应当使用固定的测试文档（确保结果可复现）
14. When 测试文档不存在时，系统应当自动创建或下载测试文档
15. When 测试完成后，系统应当清理测试产生的临时数据（可选）

#### 1.5 持续集成
16. When 代码提交时，系统应当能够自动触发回归测试（可选，通过CI/CD）
17. When 测试失败时，系统应当阻止代码合并（可选，通过CI/CD）
18. When 测试通过时，系统应当记录测试结果到历史记录中

---

## 需求 2 - API失败模拟

### 用户故事：
作为开发团队，我需要系统能够模拟DeepSeek API的各种失败场景，以便验证系统的容错能力和错误处理机制是否完善。

### 验收标准：

#### 2.1 失败场景模拟
1. When 启用API失败模拟时，系统应当能够模拟以下失败场景：
   - API调用超时（网络超时、响应超时）
   - API返回错误状态码（400、401、403、429、500、503等）
   - API返回无效响应（空响应、格式错误、JSON解析失败）
   - API限流（429 Too Many Requests）
   - API服务不可用（连接失败、DNS解析失败）
2. When 模拟API超时时，系统应当能够设置超时时间（如30秒、60秒）
3. When 模拟API错误状态码时，系统应当能够指定具体的错误码和错误信息
4. When 模拟API限流时，系统应当能够模拟限流响应（包含Retry-After头）

#### 2.2 模拟机制
5. When 配置API失败模拟时，系统应当支持通过环境变量或配置文件启用/禁用
6. When 启用模拟时，系统应当能够指定模拟的失败类型和概率
7. When 模拟失败时，系统应当记录模拟的失败场景到日志中
8. When 模拟失败时，系统应当不影响真实的API调用（仅在测试环境使用）

#### 2.3 容错验证
9. When API调用失败时，系统应当能够正确处理异常并返回友好的错误信息
10. When API调用超时时，系统应当能够触发超时处理机制
11. When API返回错误状态码时，系统应当能够根据错误类型采取相应的处理策略（重试、降级、失败）
12. When API限流时，系统应当能够实现指数退避重试机制

#### 2.4 降级策略
13. When API调用失败时，系统应当能够使用降级策略（如返回默认值、使用缓存结果）
14. When 使用降级策略时，系统应当记录降级原因和使用的降级方案
15. When 降级策略执行时，系统应当确保用户能够获得基本可用的结果

---

## 需求 3 - 结果稳定性监控

### 用户故事：
作为开发团队，我需要系统能够持续监控AI处理结果的稳定性和一致性，以便及时发现API响应质量下降或结果不稳定的问题。

### 验收标准：

#### 3.1 监控指标收集
1. When 文档处理完成后，系统应当收集以下监控指标：
   - API调用成功率（成功/失败次数）
   - API响应时间（平均、P50、P95、P99）
   - API错误类型分布（超时、错误码、解析失败等）
   - 处理结果质量指标（置信度分布、来源片段完整性、字段完整性）
2. When 收集监控指标时，系统应当记录时间戳、文档类型、处理阶段等信息
3. When 收集监控指标时，系统应当能够区分不同类型的文档（技术文档、面试题、架构文档）

#### 3.2 结果一致性检查
4. When 处理相同文档时，系统应当能够检测结果的一致性（可选，需要历史数据对比）
5. When 检测结果一致性时，系统应当比较关键字段的值（如置信度、关键内容）
6. When 发现结果不一致时，系统应当记录不一致的字段和差异值
7. When 结果一致性检查时，系统应当考虑合理的波动范围（如置信度±5%）

#### 3.3 质量趋势分析
8. When 收集监控数据时，系统应当能够分析质量趋势（如置信度平均值变化、成功率变化）
9. When 分析质量趋势时，系统应当能够识别质量下降的趋势（如置信度持续下降）
10. When 识别质量下降时，系统应当能够触发告警（可选，通过日志或通知）

#### 3.4 监控数据存储
11. When 收集监控指标时，系统应当将数据存储到数据库或监控系统
12. When 存储监控数据时，系统应当支持按时间范围查询和统计
13. When 存储监控数据时，系统应当支持数据聚合（如按小时、按天统计）

#### 3.5 监控报告
14. When 生成监控报告时，系统应当包含以下内容：
   - API调用统计（成功率、平均响应时间、错误分布）
   - 结果质量统计（置信度分布、字段完整性）
   - 质量趋势图表（可选）
   - 异常情况汇总
15. When 生成监控报告时，系统应当支持按时间范围生成（如最近24小时、最近7天）
16. When 生成监控报告时，系统应当能够导出为JSON或CSV格式（可选）

#### 3.6 告警机制
17. When 监控指标异常时，系统应当能够触发告警（如API成功率低于阈值、平均响应时间超过阈值）
18. When 触发告警时，系统应当记录告警信息到日志
19. When 触发告警时，系统应当支持发送通知（可选，如邮件、Slack、Webhook）

---

## 需求 4 - 测试和监控集成

### 用户故事：
作为开发团队，我需要测试和监控功能能够与现有系统无缝集成，不影响正常业务流程。

### 验收标准：

#### 4.1 系统集成
1. When 运行回归测试时，系统应当能够使用现有的测试文档和测试环境
2. When 启用API失败模拟时，系统应当能够在不影响生产环境的情况下进行测试
3. When 收集监控指标时，系统应当能够与现有的日志系统集成

#### 4.2 性能影响
4. When 运行回归测试时，系统应当能够控制测试频率，避免对系统造成过大压力
5. When 收集监控指标时，系统应当确保监控开销最小（如异步收集、批量写入）
6. When 启用监控时，系统应当不影响正常文档处理的性能

#### 4.3 配置管理
7. When 配置测试和监控功能时，系统应当支持通过环境变量或配置文件进行配置
8. When 配置测试和监控功能时，系统应当提供默认配置，开箱即用
9. When 配置测试和监控功能时，系统应当支持不同环境的配置（开发、测试、生产）

---

## 需求优先级

### P0 - 必须实现（核心功能）
- 需求1：自动回归测试（关键场景）- 核心场景覆盖、结果验证
- 需求2：API失败模拟 - 基本失败场景模拟、容错验证

### P1 - 重要功能（建议实现）
- 需求1：自动回归测试 - 持续集成、测试数据管理
- 需求3：结果稳定性监控 - 监控指标收集、质量趋势分析

### P2 - 可选功能（时间允许时实现）
- 需求3：结果稳定性监控 - 告警机制、监控报告
- 需求4：测试和监控集成 - 高级集成功能

---

**文档版本**：v1.0
**创建时间**：2025-12-19
**最后更新**：2025-12-19

